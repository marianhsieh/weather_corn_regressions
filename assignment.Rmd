---
title: "Weather and Corn Yield Regressions"
author: "Marian Hsieh"
date: "2/25/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(R.matlab)
library(rnassqs)
```

## Weather Data Analysis

### Load the PRISM daily maximum temperatures

```{r tmax data, include = F}
# daily max temperature
# dimensions: counties x days x years
prism <- readMat("data/prismiowa.mat") 

# look at county #1
t_1981_c1 <- prism$tmaxdaily.iowa[1,,1] #pull data out of 3d array
t_1981_c1[366]

# base R plot & ggplot
plot(1:366, t_1981_c1, type = "1")
ggplot() +
  geom_line(mapping = aes(x=1:366,y=t_1981_c1)) +
  theme_bw() +
  xlab("day of year") + ylab("daily maximum temperature (C)") +
  ggtitle("Daily Maximum Temperature, Iowa County #1")
```

```{r tidying up, include = F}
# assign dimensions names to tmax matrix
dimnames(prism$tmaxdaily.iowa) <- list(prism$COUNTYFP, 1:366, prism$years)

# converted 3d matrix into a data frame
tmaxdf <- as.data.frame.table(prism$tmaxdaily.iowa)

# re-label the columns
colnames(tmaxdf) <- c("countyfp","day","year","tmax")
tmaxdf <- tibble(tmaxdf)
```

## Temperature trends

### Summer temperature trends: Winneshiek County

```{r summer temp trends, include = F}
# convert days/years to numeric (from fct to dbl)
tmaxdf$day <- as.numeric(tmaxdf$day)
tmaxdf$year <- as.numeric(as.character(tmaxdf$year))

# tidy data
winnesummer <- tmaxdf %>%
  filter(countyfp==191 & day >= 152 & day <= 243) %>% #after June 1 AND before August 30
  group_by(year) %>%
  summarize(meantmax = mean(tmax))

# plot + trend line
ggplot(winnesummer, aes(x=year,y=meantmax)) +
  geom_point() +
  theme_bw() +
  labs(x="year", y="Tmax (C)") +
  geom_smooth(method = lm)

# regression summary
lm_summertmax <- lm(meantmax ~ year, winnesummer)
summary(lm_summertmax)

```

### Winter temperature trends: Winneshiek County

```{r winter temp trends, include = F}
# change filtered days to winter
winnewinter <- tmaxdf %>%
  filter(countyfp==191 & (day <= 59 | day >= 335) & !is.na(tmax)) %>% #before Feb 29 OR after Dec 1, exclude NAs
  group_by(year) %>%
  summarize(meantmax = mean(tmax))

# plot + trend line
ggplot(winnewinter, aes(x=year,y=meantmax)) +
  geom_point() +
  theme_bw() +
  labs(x="year", y="Tmax (C)") +
  geom_smooth(method = lm)

# regression summary
lm_wintertmax <- lm(meantmax ~ year, winnewinter)
summary(lm_wintertmax)
```

### Multiple regression -- Quadratic time trend

```{r quadratic temp trend, include = F}
#
winnewinter$yearsq <- winnewinter$year^2

# multiple regression
lm_wintertmaxquad <- lm(meantmax ~ year + yearsq, winnewinter)
summary(lm_wintertmaxquad) # positive year, negative yearsq = time trend appears to have slowed

# add fitted values to df
winnewinter$fitted <- lm_wintertmaxquad$fitted.values

# plot + trend line
ggplot(winnewinter) +
  geom_point(mapping = aes(x=year, y= meantmax)) +
  geom_line(mapping = aes(x=year, y=fitted)) +
  theme_bw() +
  labs(x="year", y="Tmax (C)")

```

### Download NASS corn yield data

```{r yield download, include = F}
# set our API key with NASS
nassqs_auth(key = "EBACEA54-5ED7-3402-8FC5-C2479C946D6B")

# parameters to query on
params <- list(commodity_desc = "CORN", util_practice_desc = "GRAIN", prodn_practice_desc = "ALL PRODUCTION PRACTICES", year__GE = 1981, state_alpha = "IA")

# download
cornyieldsall <- nassqs_yields(params)

# set county and yield as numeric
cornyieldsall$county_ansi <- as.numeric(cornyieldsall$county_ansi)
cornyieldsall$yield <- as.numeric(cornyieldsall$Value)

# clean and filter this dataset
cornyields <- select(cornyieldsall, county_ansi, county_name, yield, year) %>%
  filter(!is.na(county_ansi) & !is.na(yield))
cornyields <- tibble(cornyields)
```


## Assignment

### Question 1a: Extract Winneshiek County corn yields, fit a linear time trend, make a plot. Is there a significant time trend?

```{r question 1a, message = F}
# filter for Winneshiek County
winnecorn <- cornyields %>%
  filter(county_name == "WINNESHIEK") %>%
  group_by(year) %>%
  summarize(meanyield = mean(yield))

# summary
lm_winnecorn <- lm(meanyield ~ year, winnecorn)
summary(lm_winnecorn)

# plot + trend line
ggplot(winnecorn, aes(x=year,y=meanyield)) +
  geom_point() +
  theme_bw() +
  labs(x="Year", y="Maize yield ()") +
  ggtitle("Maize yield in Winneshiek County") +
  geom_smooth(method = lm)
```

### Question 1b: Fit a quadratic time trend (i.e., year + year^2) and make a plot. Is there evidence for slowing yield growth? 

```{r question 1b, message = F}
#
winnecorn$yearsq <- winnecorn$year^2

# multiple regression
lm_winnecornquad <- lm(meanyield ~ year + yearsq, winnecorn)
summary(lm_winnecornquad) 

# add fitted values to df
winnecorn$fitted <- lm_winnecornquad$fitted.values

# plot + trend line
ggplot(winnecorn) +
  geom_point(mapping = aes(x=year, y= meanyield)) +
  geom_line(mapping = aes(x=year, y=fitted)) +
  theme_bw() +
  labs(x="Year", y="Maize yield ()") +
  ggtitle("Maize yield in Winneshiek County")
```


### Question 2 -- Time Series: Let's analyze the relationship between temperature and yields for the Winneshiek County time series. Use data on yield and summer avg Tmax. Is adding year or Tmax^2 to your model helpful? Make a plot and interpret the results.

```{r}
# combine 

```


### Question 3 -- Cross-Section: Analyze the relationship between temperature and yield across all counties in 2018. Is there a relationship? Interpret the results.

```{r}
# 

```


### Question 4 -- Panel: One way to leverage multiple time series is to group all data into what is called a "panel" regression. Convert the county ID code ("countyfp" or "county_ansi") into factor using as.factor, then include this variable in a regression using all counties' yield and summer temperature data. How does the significance of your temperature coefficients (Tmax, Tmax^2) change? Make a plot comparing actual and fitted yields and interpret the results of your model.

```{r}
# 

```

### Question 5 -- Soybeans: Download NASS data on soybean yields and explore either a time series relationship for a given county, the cross-sectional relationship for a given year, or a panel across all counties and years.

```{r}

```

### Bonus: Find a package to make a county map of Iowa displaying some sort of information about yields or weather. Interpret your map.

```{r}

```

### Bonus #2: Challenge question - map trends in corn yields by county across Iowa. Interpret your map.

```{r}

```

